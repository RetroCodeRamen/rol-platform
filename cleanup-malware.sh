#!/bin/bash
# Malware cleanup script for production server

set -e

SERVER_IP="10.0.0.220"
SERVER_USER="root"
SERVER_PASSWORD="P0pcorn!"

echo "üö® Starting malware cleanup and server security hardening..."

sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_IP" bash << 'EOF'
set -e

echo "=== Step 1: Killing malicious processes ==="
# Kill known malicious processes
kill -9 94041 94056 155 152 2>/dev/null || echo "Some processes already killed"
sleep 2

# Find and kill any remaining xmrig processes
pkill -9 xmrig 2>/dev/null || true
pkill -9 -f "scanner.py" 2>/dev/null || true
pkill -9 -f "pcpcat" 2>/dev/null || true

echo "‚úÖ Malicious processes killed"

echo ""
echo "=== Step 2: Removing malicious files ==="
rm -rf /var/www/rol-platform/build-new/xmrig
rm -rf /root/.local/share/next
rm -rf /opt/pcpcat
rm -rf /tmp/xmrig* 2>/dev/null || true
rm -rf /tmp/.X11-unix 2>/dev/null || true

echo "‚úÖ Malicious files removed"

echo ""
echo "=== Step 3: Checking for backdoors ==="
echo "Checking cron jobs..."
crontab -l 2>/dev/null | grep -v "^#" | grep -v "^$" || echo "No user crontab"
cat /etc/crontab | grep -v "^#" | grep -v "^$" || echo "No system crontab"
ls -la /etc/cron.d/ 2>/dev/null | grep -v "^total" || echo "No cron.d files"
ls -la /etc/cron.hourly/ 2>/dev/null | grep -v "^total" || echo "No hourly cron"
ls -la /etc/cron.daily/ 2>/dev/null | grep -v "^total" || echo "No daily cron"

echo ""
echo "Checking systemd services..."
systemctl list-units --type=service | grep -i pcpcat || echo "No pcpcat services found"
systemctl list-units --type=service | grep -i suspicious || echo "No suspicious services"

echo ""
echo "Checking SSH authorized keys..."
cat ~/.ssh/authorized_keys 2>/dev/null || echo "No authorized_keys file"

echo ""
echo "=== Step 4: Checking network connections ==="
echo "Suspicious ports:"
netstat -tulpn 2>/dev/null | grep -E '1080|3333|4444|5555' || echo "No suspicious ports found"

echo ""
echo "=== Step 5: Installing security tools ==="
apt-get update -qq
apt-get install -y fail2ban ufw 2>/dev/null || echo "Security tools already installed"

echo ""
echo "=== Step 6: Setting up firewall ==="
# Allow SSH, HTTP, HTTPS, and our app port
ufw --force enable || true
ufw default deny incoming
ufw default allow outgoing
ufw allow 22/tcp comment 'SSH'
ufw allow 80/tcp comment 'HTTP'
ufw allow 443/tcp comment 'HTTPS'
ufw allow 3001/tcp comment 'ROL Platform'
ufw --force reload || true

echo "‚úÖ Firewall configured"

echo ""
echo "=== Step 7: Securing SSH ==="
# Backup SSH config
cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup.$(date +%Y%m%d)

# Secure SSH config (will need manual review)
sed -i 's/#PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config || true
sed -i 's/#PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config || true
sed -i 's/PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config || true

echo "‚ö†Ô∏è  SSH config updated - review /etc/ssh/sshd_config before restarting SSH"
echo "‚ö†Ô∏è  Ensure SSH keys are set up before disabling password auth!"

echo ""
echo "=== Step 8: Checking recent auth logs ==="
echo "Recent failed login attempts:"
grep "Failed password" /var/log/auth.log 2>/dev/null | tail -20 || echo "No failed attempts found"

echo ""
echo "Recent successful logins:"
grep "Accepted" /var/log/auth.log 2>/dev/null | tail -10 || echo "No recent logins"

echo ""
echo "=== Cleanup Complete ==="
echo "Next steps:"
echo "1. Review SSH config: /etc/ssh/sshd_config"
echo "2. Set up SSH keys if not already done"
echo "3. Restart SSH: systemctl restart sshd"
echo "4. Monitor server: watch -n 1 'ps aux --sort=-%cpu | head -10'"
echo "5. Check for return of malware processes"

EOF

echo ""
echo "‚úÖ Malware cleanup script completed!"
echo ""
echo "‚ö†Ô∏è  IMPORTANT: Review SSH configuration before restarting SSH service"
echo "‚ö†Ô∏è  Make sure you have SSH key access before disabling password authentication"

